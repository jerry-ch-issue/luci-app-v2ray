/**
 * @license
 * Copyright 2020 Xingwang Liao <kuoruan@gmail.com>
 *
 * Licensed to the public under the MIT License.
 */
"use strict";"require form";"require uci";"require v2ray";"require ui";"require fs";"require validation";"require tools/widgets as widgets";"require view/v2ray/tools/converters as converters";return L.view.extend({handleImportSave:function(e){for(var o=e.split(/\r?\n/),a=0,t=0,s=o;t<s.length;t++){var r=s[t],l=void 0;if(r&&(l=converters.vmessLinkToVmess(r))&&"2"===l.v){var n=uci.add("v2ray","outbound");if(n){var d=l.add||"0.0.0.0",i=l.port||"0",p=l.tls||"",m=l.net||"",u=l.type||"",c=l.path||"",y=l.ps||"%s:%s".format(d,i);uci.set("v2ray",n,"alias",y),uci.set("v2ray",n,"protocol","vmess"),uci.set("v2ray",n,"s_vmess_address",d),uci.set("v2ray",n,"s_vmess_port",i),uci.set("v2ray",n,"s_vmess_user_id",l.id||""),uci.set("v2ray",n,"s_vmess_user_alter_id",l.aid||""),uci.set("v2ray",n,"ss_security",p);var v=[];switch(l.host&&(v=l.host.split(",")),m){case"tcp":uci.set("v2ray",n,"ss_network","tcp"),uci.set("v2ray",n,"ss_tcp_header_type",u),"http"===u&&v.length>0&&(uci.set("v2ray",n,"ss_tcp_header_request_headers",["Host=%s".format(v[0])]),"tls"===p&&uci.set("v2ray",n,"ss_tls_server_name",v[0]));break;case"kcp":case"mkcp":uci.set("v2ray",n,"ss_network","kcp"),uci.set("v2ray",n,"ss_kcp_header_type",u);break;case"ws":uci.set("v2ray",n,"ss_network","ws"),uci.set("v2ray",n,"ss_websocket_path",c);break;case"http":case"h2":uci.set("v2ray",n,"ss_network","http"),uci.set("v2ray",n,"ss_http_path",c),v.length>0&&(uci.set("v2ray",n,"ss_http_host",v),uci.set("v2ray",n,"ss_tls_server_name",v[0]));break;case"quic":uci.set("v2ray",n,"ss_network","quic"),uci.set("v2ray",n,"ss_quic_header_type",u),uci.set("v2ray",n,"ss_quic_key",c),v.length>0&&(uci.set("v2ray",n,"ss_quic_security",v[0]),"tls"===p&&uci.set("v2ray",n,"ss_tls_server_name",v[0]));break;default:uci.remove("v2ray",n);continue}a++}}}if(a>0)return uci.save().then((function(){ui.showModal(_("Outbound Import"),[E("p",{},_("Imported %d links.").format(a)),E("div",{class:"right"},E("button",{class:"btn",click:ui.createHandlerFn(this,(function(){return uci.apply().then((function(){ui.hideModal(),window.location.reload()}))}))},_("OK")))])}));ui.showModal(_("Outbound Import"),[E("p",{},_("No links imported.")),E("div",{class:"right"},E("button",{class:"btn",click:ui.hideModal},_("OK")))])},handleImportClick:function(){var e=new ui.Textarea("",{rows:10,placeholder:_("You can add multiple links at once, one link per line."),validate:function(e){return e?!!/^(vmess:\/\/[a-zA-Z0-9/+=]+\s*)+$/i.test(e)||_("Invalid links."):_("Empty field.")}});ui.showModal(_("Import Vmess Links"),[E("div",{},[E("p",{},_("Allowed link format: <code>%s</code>").format("vmess://xxxxx")),e.render()]),E("div",{class:"right"},[E("button",{class:"btn",click:ui.hideModal},_("Dismiss"))," ",E("button",{class:"cbi-button cbi-button-positive important",click:ui.createHandlerFn(this,(function(e){var o;if(e.triggerValidation(),e.isValid()&&(o=e.getValue())&&(o=o.trim()))return this.handleImportSave(o)}),e)},_("Save"))])])},load:function(){return uci.load("v2ray").then((function(){var e=fs.read("/proc/sys/net/ipv4/tcp_available_congestion_control").then((function(e){return e.split(" ")}));return Promise.all([v2ray.getSections("inbound","alias"),v2ray.getSections("inbound","tag"),v2ray.getSections("outbound","alias"),v2ray.getSections("outbound","tag"),v2ray.getSections("reverse","bridges"),v2ray.getSections("reverse","portals"),v2ray.getXtlsSecurity(),v2ray.getCore(),e])}))},render:function(e){var o,a=void 0===e?[]:e,t=a[0],s=void 0===t?[]:t,r=a[1],l=void 0===r?[]:r,n=a[2],d=void 0===n?[]:n,i=a[3],p=void 0===i?[]:i,m=a[4],u=void 0===m?[]:m,c=a[5],y=void 0===c?[]:c,v=a[6],f=void 0===v?[]:v,h=a[7],g=void 0===h?"":h,b=a[8],k=void 0===b?[]:b,w=new form.Map("v2ray","%s - %s".format(g,_("Outbound"))),V=w.section(form.GridSection,"outbound");V.addremove=!0,V.sortable=!0,V.sectiontitle=function(e){return uci.get("v2ray",e,"alias")},V.modaltitle=function(e){var o=uci.get("v2ray",e,"alias");return _("Outbound")+" > "+(null!=o?o:_("Add"))},V.nodescriptions=!0,V.tab("general",_("General Settings")),V.tab("stream",_("Stream Settings")),V.tab("mux",_("Mux Settings")),(o=V.taboption("general",form.Value,"alias",_("Alias"))).rmempty=!1,o.modalonly=!0,(o=V.taboption("general",form.Value,"tag",_("Tag"))).rmempty=!1,(o=V.taboption("general",widgets.NetworkSelect,"send_through",_("Send through"))).filter=function(e,o){return o.toUpperCase().indexOf("LAN")<0},o.nocreate=!0,o.multiple=!1,o.rmempty=!0,(o=V.taboption("general",form.ListValue,"protocol",_("Protocol"))).value("blackhole","Blackhole"),o.value("dns","DNS"),o.value("freedom","Freedom"),o.value("http","HTTP/2"),o.value("hysteria2","Hysteria2"),o.value("loopback"),o.value("mtproto","MTProto"),o.value("shadowsocks","Shadowsocks"),o.value("socks","Socks"),o.value("trojan","Trojan"),o.value("vless","VLESS"),o.value("vmess","VMess"),o.value("wireguard","WireGuard"),(o=V.taboption("general",form.ListValue,"s_blackhole_reponse_type","%s - %s".format("Blackhole",_("Response type")))).modalonly=!0,o.depends("protocol","blackhole"),o.value(""),o.value("none",_("None")),o.value("http","HTTP"),(o=V.taboption("general",form.ListValue,"s_dns_network","%s - %s".format("DNS",_("Network")))).modalonly=!0,o.depends("protocol","dns"),o.value(""),o.value("tcp","TCP"),o.value("udp","UDP"),(o=V.taboption("general",form.Value,"s_dns_address","%s - %s".format("DNS",_("Address")))).modalonly=!0,o.depends("protocol","dns"),(o=V.taboption("general",form.Value,"s_dns_port","%s - %s".format("DNS",_("Port")))).modalonly=!0,o.depends("protocol","dns"),o.datatype="port",(o=V.taboption("general",form.ListValue,"s_dns_non_ip_query",_("Non IP Queries"))).modalonly=!0,o.depends("protocol","dns"),o.value("",_("Default")),o.value("drop",_("Drop")),o.value("skip",_("Skip")),(o=V.taboption("general",form.ListValue,"s_freedom_domain_strategy","%s - %s".format("Freedom",_("Domain strategy")))).modalonly=!0,o.depends("protocol","freedom"),o.value(""),o.value("AsIs"),o.value("ForceIP"),o.value("ForceIPv4"),o.value("ForceIPv6"),o.value("ForceIPv4v6"),o.value("ForceIPv6v4"),o.value("UseIP"),o.value("UseIPv4"),o.value("UseIPv6"),o.value("UseIPv4v6"),o.value("UseIPv6v4"),(o=V.taboption("general",form.Value,"s_freedom_redirect","%s - %s".format("Freedom",_("Redirect")))).modalonly=!0,o.depends("protocol","freedom"),(o=V.taboption("general",form.Flag,"s_freedom_fragment_enabled","%s - %s".format(_("TCP Fragmentize"),_("Enabled")))).modalonly=!0,o.depends("protocol","freedom"),o.rmempty=!0,o.disabled="0",o.enabled="1",(o=V.taboption("general",form.Value,"s_freedom_fragment_length","%s - %s".format(_("Fragment"),_("Length")))).modalonly=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("fragment-length",o)},o.rmempty=!0,o.depends("s_freedom_fragment_enabled","1"),(o=V.taboption("general",form.Value,"s_freedom_fragment_interval","%s - %s".format(_("Fragment"),_("Interval")))).modalonly=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("fragment-interval",o)},o.rmempty=!0,o.depends("s_freedom_fragment_enabled","1"),(o=V.taboption("general",form.Value,"s_freedom_fragment_packets","%s - %s".format(_("Fragment"),_("Packets")))).modalonly=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("fragment-packets",o)},o.rmempty=!0,o.depends("s_freedom_fragment_enabled","1"),o.value("tlshello",_("TLS Hello Packet")),o.value("",_("All Packets")),(o=V.taboption("general",form.Value,"s_freedom_user_level","%s - %s".format("Freedom",_("User level")))).modalonly=!0,o.depends("protocol","freedom"),o.datatype="uinteger",(o=V.taboption("general",form.Value,"s_http_address","%s - %s".format("HTTP",_("Server address")))).modalonly=!0,o.depends("protocol","http"),o.datatype="host",(o=V.taboption("general",form.Value,"s_http_server_port","%s - %s".format("HTTP",_("Server port")))).modalonly=!0,o.depends("protocol","http"),o.datatype="port",(o=V.taboption("general",form.Value,"s_http_account_user","%s - %s".format("HTTP",_("User")))).modalonly=!0,o.depends("protocol","http"),(o=V.taboption("general",form.Value,"s_http_account_pass","%s - %s".format("HTTP",_("Password")))).modalonly=!0,o.depends("protocol","http"),o.password=!0,(o=V.taboption("general",form.DynamicList,"s_http_headers","%s - %s".format("HTTP",_("Headers")),_("Custom HTTP Headers,format: <code>header=value</code>"))).modalonly=!0,o.depends("protocol","http"),o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_address","%s - %s".format("Hysteria2",_("Server address")))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="ipaddr",(o=V.taboption("general",form.Value,"s_hysteria2_port","%s - %s".format("Hysteria2",_("Server port")))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="port",(o=V.taboption("general",form.Value,"s_hysteria2_auth","%s - %s".format("Hysteria2",_("Password")))).modalonly=!0,o.depends("protocol","hysteria2"),o.password=!0,(o=V.taboption("general",form.Value,"s_hysteria2_tls_sni","Hysteria2 - SNI")).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="host",o.rmempty=!0,(o=V.taboption("general",form.ListValue,"s_hysteria2_tls_insecure",_("Allow Insecure TLS Connection"))).modalonly=!0,o.depends("protocol","hysteria2"),o.value("false",_("False")),o.value("true",_("True")),o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_tls_pinsha256","TLS pinSHA256")).modalonly=!0,o.depends("protocol","hysteria2"),o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_tls_ca","TLS CA")).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="file",o.rmempty=!0,(o=V.taboption("general",form.ListValue,"s_hysteria2_domain_strategy",_("Domain Strategy"))).modalonly=!0,o.depends("protocol","hysteria2"),o.value("UseIP"),o.value("UseIPv4"),o.value("UseIPv6"),(o=V.taboption("general",form.Value,"s_hysteria2_udp_hopinterval",_("udp Hop Interval"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="and(uinteger, range(10, 100))",o.placeholder="30",o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_quic_initStreamRW",_("Initial Stream Receive Window"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="uinteger",o.placeholder="8388608",o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_quic_maxStreamRW",_("Maximum Stream Receive Window"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="uinteger",o.placeholder="8388608",o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_quic_initConnRW",_("Initial Connection Receive Window"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="uinteger",o.placeholder="20971520",o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_quic_maxConnRW",_("Maximum Connection Receive Window"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="uinteger",o.placeholder="20971520",o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_quic_maxConnRW",_("Maximum Connection Receive Window"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="uinteger",o.placeholder="20971520",o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_quic_maxIdleTO",_("Maximum Idle Timeout"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="and(uinteger, min(10))",o.placeholder="30",o.rmempty=!0,(o=V.taboption("general",form.Value,"s_hysteria2_quic_keepalive",_("Keep Alive Period"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="and(uinteger, min(10))",o.placeholder="10",o.rmempty=!0,(o=V.taboption("general",form.ListValue,"s_hysteria2_quic_disableMTU",_("Disable Path MTU Discovery"))).modalonly=!0,o.depends("protocol","hysteria2"),o.value("false",_("False")),o.value("true",_("True")),(o=V.taboption("general",form.Value,"s_hysteria2_bw_up",_("Expected Upload Bandwidth(In Mbps)"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="and(uinteger, range(10, 1000))",o.placeholder="50",o.rmempty=!1,(o=V.taboption("general",form.Value,"s_hysteria2_bw_down",_("Expected Download Bandwidth(In Mbps)"))).modalonly=!0,o.depends("protocol","hysteria2"),o.datatype="and(uinteger, min(10, 1000))",o.placeholder="100",o.rmempty=!1,(o=V.taboption("general",form.ListValue,"s_loopback_inboundtag","%s - %s".format("Loopback",_("Inbound Tag")))).modalonly=!0,o.depends("protocol","loopback"),o.value("",_("None"));for(var P=0;P<s.length;P++)o.value(l[P].caption,s[P].caption+"("+l[P].caption+")");for(var S=0,T=u;S<T.length;S++)for(var x=T[S],I=0,C=String(x.caption).split(",");I<C.length;I++){var H=C[I];o.value(H.substring(0,H.indexOf("|")),H)}(o=V.taboption("general",form.Value,"s_shadowsocks_email","%s - %s".format("Shadowsocks",_("Email")))).modalonly=!0,o.depends("protocol","shadowsocks"),(o=V.taboption("general",form.Value,"s_shadowsocks_address","%s - %s".format("Shadowsocks",_("Address")))).modalonly=!0,o.depends("protocol","shadowsocks"),o.datatype="host",(o=V.taboption("general",form.Value,"s_shadowsocks_port","%s - %s".format("Shadowsocks",_("Port")))).modalonly=!0,o.depends("protocol","shadowsocks"),o.datatype="port",(o=V.taboption("general",form.ListValue,"s_shadowsocks_method","%s - %s".format("Shadowsocks",_("Method")))).modalonly=!0,o.depends("protocol","shadowsocks"),o.value(""),o.value("aes-256-cfb"),o.value("aes-128-cfb"),o.value("chacha20"),o.value("chacha20-ietf"),o.value("aes-256-gcm"),o.value("aes-128-gcm"),o.value("chacha20-poly1305"),o.value("chacha20-ietf-poly1305"),(o=V.taboption("general",form.Value,"s_shadowsocks_password","%s - %s".format("Shadowsocks",_("Password")))).modalonly=!0,o.depends("protocol","shadowsocks"),o.password=!0,(o=V.taboption("general",form.Value,"s_shadowsocks_level","%s - %s".format("Shadowsocks",_("User level")))).modalonly=!0,o.depends("protocol","shadowsocks"),o.datatype="uinteger",(o=V.taboption("general",form.Flag,"s_shadowsocks_ota","%s - %s".format("Shadowsocks",_("OTA")))).modalonly=!0,o.depends("protocol","shadowsocks"),(o=V.taboption("general",form.Value,"s_socks_server_address","%s - %s".format("Socks",_("Server address")))).modalonly=!0,o.depends("protocol","socks"),o.datatype="host",(o=V.taboption("general",form.Value,"s_socks_server_port","%s - %s".format("Socks",_("Server port")))).modalonly=!0,o.depends("protocol","socks"),o.datatype="port",(o=V.taboption("general",form.Value,"s_socks_account_user","%s - %s".format("Socks",_("User")))).modalonly=!0,o.depends("protocol","socks"),(o=V.taboption("general",form.Value,"s_socks_account_pass","%s - %s".format("Socks",_("Password")))).modalonly=!0,o.depends("protocol","socks"),o.password=!0,(o=V.taboption("general",form.Value,"s_socks_user_level","%s - %s".format("Socks",_("User level")))).modalonly=!0,o.depends("protocol","socks"),o.datatype="uinteger",(o=V.taboption("general",form.Value,"s_trojan_address","%s - %s".format("Trojan",_("Address")))).depends("protocol","trojan"),o.modalonly=!0,o.datatype="host",(o=V.taboption("general",form.Value,"s_trojan_port","%s - %s".format("Trojan",_("Port")))).depends("protocol","trojan"),o.modalonly=!0,o.datatype="port",(o=V.taboption("general",form.Value,"s_trojan_password","%s - %s".format("Trojan",_("Password")))).depends("protocol","trojan"),o.modalonly=!0,(o=V.taboption("general",form.Value,"s_vless_address","%s - %s".format("VLESS",_("Address")))).depends("protocol","vless"),o.modalonly=!0,o.datatype="host",(o=V.taboption("general",form.Value,"s_vless_port","%s - %s".format("VLESS",_("Port")))).depends("protocol","vless"),o.modalonly=!0,o.datatype="port",(o=V.taboption("general",form.Value,"s_vless_user_id","%s - %s".format("VLESS",_("User ID")))).modalonly=!0,o.depends("protocol","vless"),(o=V.taboption("general",form.Value,"s_vless_user_level","%s - %s".format("VLESS",_("User Level")))).modalonly=!0,o.depends("protocol","vless"),o.datatype="and(uinteger, max(10))",(o=V.taboption("general",form.ListValue,"s_vless_user_encryption","%s - %s".format("VLESS",_("Encryption")))).modalonly=!0,o.depends("protocol","vless"),o.value("none"),(o=V.taboption("general",form.Value,"s_vmess_address","%s - %s".format("VMess",_("Address")))).modalonly=!0,o.depends("protocol","vmess"),o.datatype="host",(o=V.taboption("general",form.Value,"s_vmess_port","%s - %s".format("VMess",_("Port")))).modalonly=!0,o.depends("protocol","vmess"),o.datatype="port",(o=V.taboption("general",form.Value,"s_vmess_user_id","%s - %s".format("VMess",_("User ID")))).modalonly=!0,o.depends("protocol","vmess"),(o=V.taboption("general",form.Value,"s_vmess_user_alter_id","%s - %s".format("VMess",_("Alter ID")))).modalonly=!0,o.depends("protocol","vmess"),o.datatype="and(uinteger, max(65535))",(o=V.taboption("general",form.ListValue,"s_vmess_user_security","%s - %s".format("VMess",_("Security")))).modalonly=!0,o.depends("protocol","vmess"),o.value(""),o.value("auto",_("Auto")),o.value("aes-128-gcm"),o.value("chacha20-poly1305"),o.value("none",_("None")),(o=V.taboption("general",form.Value,"s_vmess_user_level","%s - %s".format("VMess",_("User level")))).modalonly=!0,o.depends("protocol","vmess"),o.datatype="uinteger",(o=V.taboption("general",form.Value,"s_wireguard_secret_key",_("Private Key"))).depends("protocol","wireguard"),o.validate=function(e,o){return v2ray.v2rayValidation("wg-keys",o)},o.modalonly=!0,o.rmempty=!1,(o=V.taboption("general",form.DynamicList,"s_wireguard_address",_("Address"))).depends("protocol","wireguard"),o.modalonly=!0,o.optional=!0,o.datatype="or(ipaddr, cidr)",(o=V.taboption("general",form.Value,"s_wireguard_endpoint",_("Endpoint"))).depends("protocol","wireguard"),o.rmempty=!1,o.modalonly=!0,o.datatype="or(hostport(0), ipaddrport(1))",o.placeholder="[2606:4700:d0::a29f:c001]:2408",(o=V.taboption("general",form.Value,"s_wireguard_public_key",_("Public Key"))).depends("protocol","wireguard"),o.validate=function(e,o){return v2ray.v2rayValidation("wg-keys",o)},o.rmempty=!1,o.modalonly=!0,(o=V.taboption("general",form.Value,"s_wireguard_preshared_key",_("Pre-Shared Key"))).depends("protocol","wireguard"),o.rmempty=!0,o.modalonly=!0,o.optional=!0,(o=V.taboption("general",form.DynamicList,"s_wireguard_allowed_ips",_("Allowed IPs"))).depends("protocol","wireguard"),o.rmempty=!0,o.modalonly=!0,o.datatype="or(ipaddr, cidr)",o.optional=!0,(o=V.taboption("general",form.Value,"s_wireguard_keep_alive",_("Keep Alive"))).depends("protocol","wireguard"),o.rmempty=!0,o.modalonly=!0,o.datatype="uinteger",o.optional=!0,(o=V.taboption("general",form.Value,"s_wireguard_mtu",_("MTU"))).depends("protocol","wireguard"),o.rmempty=!0,o.modalonly=!0,o.datatype="and(uinteger, range(1280, 1420))",o.optional=!0,(o=V.taboption("general",form.Value,"s_wireguard_reserved_bytes",_("Reserved Bytes"))).depends("protocol","wireguard"),o.modalonly=!0,o.optional=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("wg-reserved",o)},o.rmempty=!0,o.placeholder="0,123,255",o.optional=!0,(o=V.taboption("stream",form.ListValue,"ss_network",_("Network"))).depends({protocol:/\b(http|trojan|vless|vmess)\b/}),o.value(""),o.value("grpc","gRPC"),o.value("tcp","TCP"),o.value("kcp","mKCP"),o.value("ws","WebSocket"),o.value("h2","HTTP/2"),o.value("httpupgrade","HttpUpgrade"),o.value("domainsocket","Domain Socket"),o.value("quic","QUIC"),(o=V.taboption("stream",form.ListValue,"ss_security",_("Security"))).depends({protocol:/\b(http|trojan|vless|vmess)\b/}),o.modalonly=!0,o.rmempty=!1,o.value("none",_("None")),o.value("tls","TLS");for(var D=0,q=f;D<q.length;D++)for(var U=0,A=q[D].security;U<A.length;U++){var M=A[U];o.value(M.substring(0,M.indexOf("|")),M.substring(M.indexOf("|")+1))}(o=V.taboption("stream",form.ListValue,"s_xtls_flow",_("Flow"))).modalonly=!0,o.rmempty=!0,o.optional=!0,o.depends({protocol:"vless",ss_network:/\b(tcp|kcp|domainsocket)\b/,reality_check:"0",ss_security:"xtls"}),o.depends({protocol:"vless",ss_network:/\b(tcp|kcp|domainsocket|ws|grpc|httpupgrade)\b/,reality_check:"1",ss_security:"tls"}),o.depends({protocol:"vless",ss_network:/\b(tcp|kcp|domainsocket|ws|grpc|httpupgrade)\b/,reality_check:"1",ss_security:"reality"}),o.value("","None");for(var N=0,F=f;N<F.length;N++)for(var R=0,W=(M=F[N]).flow;R<W.length;R++){var O=W[R];o.value(O)}(o=V.taboption("stream",form.Value,"ss_tls_server_name",_("Server name"))).modalonly=!0,o.depends({ss_security:/tls$/}),o.validate=function(e,o){return v2ray.v2rayValidation("sni",o,e)},(o=V.taboption("stream",form.MultiValue,"ss_tls_alpn","ALPN")).modalonly=!0,o.depends({ss_security:/tls$/}),o.value("h2"),o.value("http/1.1"),(o=V.taboption("stream",form.Flag,"ss_tls_allow_insecure",_("Allow insecure"))).modalonly=!0,o.depends({ss_security:/tls$/}),(o=V.taboption("stream",form.Flag,"ss_tls_allow_insecure_ciphers",_("Allow insecure ciphers"))).modalonly=!0,o.depends({ss_security:/tls$/}),(o=V.taboption("stream",form.Flag,"ss_tls_disable_system_root",_("Disable system root"))).modalonly=!0,o.depends({ss_security:/tls$/}),(o=V.taboption("stream",form.ListValue,"ss_tls_cert_usage",_("Certificate usage"))).modalonly=!0,o.depends({ss_security:/tls$/}),o.value(""),o.value("encipherment"),o.value("verify"),o.value("issue"),(o=V.taboption("stream",form.Value,"ss_tls_cert_fiile",_("Certificate file"))).modalonly=!0,o.depends({ss_security:/tls$/}),(o=V.taboption("stream",form.Value,"ss_tls_key_file",_("Key file"))).modalonly=!0,o.depends({ss_security:/tls$/}),(o=V.taboption("stream",form.ListValue,"ss_reality_show","%s - %s".format("Debug",_("Info")),_("Show REALITY Debug Info"))).modalonly=!0,o.depends("ss_security","reality"),o.value("1",_("Show")),o.value("0",_("Hide")),(o=V.taboption("stream",form.ListValue,"ss_reality_fingerprint",_("fingerprint"))).modalonly=!0,o.depends({ss_security:/\b(reality|tls|xtls)\b/}),o.value("","none"),o.value("360"),o.value("chrome"),o.value("edge"),o.value("firefox"),o.value("ios"),o.value("qq"),o.value("random"),o.value("randomized"),o.value("safari"),(o=V.taboption("stream",form.Value,"ss_reality_server_name",_("Server Name"))).modalonly=!0,o.datatype="hostname",o.validate=function(e,o){return!o||v2ray.v2rayValidation("sni",o,e)},o.depends("ss_security","reality"),o.placeholder="example.com",(o=V.taboption("stream",form.Value,"ss_reality_public_key",_("Public Key"))).modalonly=!0,o.depends("ss_security","reality"),o.datatype="rangelength(43, 43)",(o=V.taboption("stream",form.Value,"ss_reality_short_id",_("Short ID"))).modalonly=!0,o.depends("ss_security","reality"),o.datatype="and(hexstring, maxlength(16))",o.rmempty=!0,(o=V.taboption("stream",form.Value,"ss_reality_spiderx",_("Spider Parameters"))).modalonly=!0,o.depends("ss_security","reality"),o.rmempty=!0,(o=V.taboption("stream",form.ListValue,"ss_tcp_header_type","%s - %s".format("TCP",_("Header type")))).modalonly=!0,o.depends("ss_network","tcp"),o.value(""),o.value("none",_("None")),o.value("http","HTTP"),(o=V.taboption("stream",form.Value,"ss_tcp_header_request_version","%s - %s".format("TCP",_("HTTP request version")))).modalonly=!0,o.depends("ss_tcp_header_type","http"),(o=V.taboption("stream",form.ListValue,"ss_tcp_header_request_method","%s - %s".format("TCP",_("HTTP request method")))).modalonly=!0,o.depends("ss_tcp_header_type","http"),o.value(""),o.value("GET"),o.value("HEAD"),o.value("POST"),o.value("DELETE"),o.value("PUT"),o.value("PATCH"),o.value("OPTIONS"),(o=V.taboption("stream",form.Value,"ss_tcp_header_request_path","%s - %s".format("TCP",_("Request path")))).modalonly=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("path",o)},o.depends("ss_tcp_header_type","http"),(o=V.taboption("stream",form.DynamicList,"ss_tcp_header_request_headers","%s - %s".format("TCP",_("Request headers")),_("A list of HTTP headers, format: <code>header=value</code>. eg: %s").format("Host=www.bing.com"))).modalonly=!0,o.depends("ss_tcp_header_type","http"),(o=V.taboption("stream",form.Value,"ss_tcp_header_response_version","%s - %s".format("TCP",_("HTTP response version")))).modalonly=!0,o.depends("ss_tcp_header_type","http"),(o=V.taboption("stream",form.Value,"ss_tcp_header_response_status","%s - %s".format("TCP",_("HTTP response status")))).modalonly=!0,o.depends("ss_tcp_header_type","http"),(o=V.taboption("stream",form.Value,"ss_tcp_header_response_reason","%s - %s".format("TCP",_("HTTP response reason")))).modalonly=!0,o.depends("ss_tcp_header_type","http"),(o=V.taboption("stream",form.DynamicList,"ss_tcp_header_response_headers","%s - %s".format("TCP",_("Response headers")),_("A list of HTTP headers, format: <code>header=value</code>. eg: %s").format("Host=www.bing.com"))).modalonly=!0,o.depends("ss_tcp_header_type","http"),(o=V.taboption("stream",form.Value,"ss_kcp_mtu","%s - %s".format("mKCP",_("Maximum transmission unit (MTU)")))).modalonly=!0,o.depends("ss_network","kcp"),o.datatype="and(min(576), max(1460))",o.placeholder="1350",(o=V.taboption("stream",form.Value,"ss_kcp_tti","%s - %s".format("mKCP",_("Transmission time interval (TTI)")))).modalonly=!0,o.depends("ss_network","kcp"),o.datatype="and(min(10), max(100))",o.placeholder="50",(o=V.taboption("stream",form.Value,"ss_kcp_uplink_capacity","%s - %s".format("mKCP",_("Uplink capacity")))).modalonly=!0,o.depends("ss_network","kcp"),o.datatype="uinteger",o.placeholder="5",(o=V.taboption("stream",form.Value,"ss_kcp_downlink_capacity","%s - %s".format("mKCP",_("Downlink capacity")))).modalonly=!0,o.depends("ss_network","kcp"),o.datatype="uinteger",o.placeholder="20",(o=V.taboption("stream",form.Flag,"ss_kcp_congestion","%s - %s".format("mKCP",_("Congestion enabled")))).modalonly=!0,o.depends("ss_network","kcp"),(o=V.taboption("stream",form.Value,"ss_kcp_read_buffer_size","%s - %s".format("mKCP",_("Read buffer size")))).modalonly=!0,o.depends("ss_network","kcp"),o.datatype="uinteger",o.placeholder="2",(o=V.taboption("stream",form.Value,"ss_kcp_write_buffer_size","%s - %s".format("mKCP",_("Write buffer size")))).modalonly=!0,o.depends("ss_network","kcp"),o.datatype="uinteger",o.placeholder="2",(o=V.taboption("stream",form.ListValue,"ss_kcp_header_type","%s - %s".format("mKCP",_("Header type")))).modalonly=!0,o.depends("ss_network","kcp"),o.value(""),o.value("none",_("None")),o.value("srtp","SRTP"),o.value("utp","uTP"),o.value("wechat-video",_("Wechat Video")),o.value("dtls","DTLS 1.2"),o.value("wireguard","WireGuard"),(o=V.taboption("stream",form.Value,"ss_websocket_path","%s - %s".format("WebSocket",_("Path")))).modalonly=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("path",o)},o.depends("ss_network","ws"),(o=V.taboption("stream",form.Value,"ss_websocket_headers","%s - %s".format("WebSocket",_("Host")))).modalonly=!0,o.datatype="hostname",o.validate=function(e,o){return v2ray.v2rayValidation("sni",o,e)},o.depends("ss_network","ws"),o.rmempty=!0,(o=V.taboption("stream",form.Value,"ss_grpc_authority","%s %s".format("grpc",_("Domain")))).modalonly=!0,o.rmempty=!0,o.datatype="hostname",o.depends("ss_netwoork","grpc"),o.placeholder="www.example.com",(o=V.taboption("stream",form.Value,"ss_grpc_service_name","%s %s".format(_("Service"),_("Name")))).modalonly=!0,o.rmempty=!1,o.validate=function(e,o){return!!o.match(/(?![-_])^[/a-z0-9-_]+(?<![_-])$/i)||_("Invalid Service Name")},o.depends("ss_network","grpc"),o.placeholder="gRPC_Service",(o=V.taboption("stream",form.ListValue,"ss_grpc_multi_mode","%s %s".format("gRPC",_("Mode")))).modalonly=!0,o.depends("ss_network","grpc"),o.value("0","gun"),o.value("1","Multi"),(o=V.taboption("stream",form.ListValue,"ss_grpc_permit_without_stream",_("Health Check"))).modalonly=!0,o.depends("ss_network","grpc"),o.value("0",_("Disabled")),o.value("1",_("Enabled")),(o=V.taboption("stream",form.Value,"ss_grpc_idle_timeout",_("Idle Timeout"),_("No less than 10 seconds"))).modalonly=!0,o.depends("ss_network","grpc"),o.datatype="and(min(10), uinteger)",o.placeholder="10",(o=V.taboption("stream",form.Value,"ss_grpc_health_check_timeout",_("Health Check timeout"))).modalonly=!0,o.depends("ss_grpc_permit_without_stream","true"),o.datatype="and(min(10), uinteger)",o.placeholder="20",(o=V.taboption("stream",form.Value,"ss_grpc_initial_windows_size",_("Initial Windows Size"),_("While connecting through Cloudflare CDN</br> set Initial Windows Size greater than <code>65536</code> to disable Dynamic Window mechanism"))).modalonly=!0,o.depends("ss_network","grpc"),o.datatype="uinteger",(o=V.taboption("stream",form.DynamicList,"ss_http_host","%s - %s".format("HTTP/2",_("Host")))).modalonly=!0,o.datatype="hostname",o.validate=function(e,o){return o?v2ray.domainRule(o,!0):"%s: %s".format(_("Expecting"),_("a valid domain name"))},o.depends("ss_network","h2"),(o=V.taboption("stream",form.Value,"ss_http_path","%s - %s".format("HTTP/2",_("Path")))).modalonly=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("path",o)},o.depends("ss_network","h2"),o.placeholder="/",(o=V.taboption("stream",form.ListValue,"ss_httpupgrade_accept_proxy_protocol","Accept Proxy Protocol")).modalonly=!0,o.value("0",_("False")),o.value("1",_("True")),o.depends("ss_network","httpupgrade"),(o=V.taboption("stream",form.Value,"ss_httpupgrade_path","%s - %s".format("HTTP Upgrade",_("Path")))).modalonly=!0,o.validate=function(e,o){return!!o&&v2ray.v2rayValidation("path",o)},o.placeholder="/",o.depends("ss_network","httpupgrade"),(o=V.taboption("stream",form.Value,"ss_httpupgrade_host","%s - %s".format("HTTP Upgrade",_("Domain")))).modalonly=!0,o.datatype="hostname",o.validate=function(e,o){return v2ray.v2rayValidation("sni",o,e)},o.rmempty=!0,o.depends("ss_network","httpupgrade"),(o=V.taboption("stream",form.Value,"ss_domainsocket_path","%s - %s".format("Domain Socket",_("Path")))).modalonly=!0,o.validate=function(e,o){return!o||v2ray.v2rayValidation("path",o)},o.depends("ss_network","domainsocket"),(o=V.taboption("stream",form.ListValue,"ss_quic_security","%s - %s".format("QUIC",_("Security")))).modalonly=!0,o.depends("ss_network","quic"),o.value("none",_("None")),o.value("aes-128-gcm"),o.value("chacha20-poly1305"),(o=V.taboption("stream",form.Value,"ss_quic_key","%s - %s".format("QUIC",_("Key")))).modalonly=!0,o.depends({ss_quic_security:/\b(aes-128-gcm|chacha20-poly1305)\b/}),(o=V.taboption("stream",form.ListValue,"ss_quic_header_type","%s - %s".format("QUIC",_("Header type")))).modalonly=!0,o.depends("ss_network","quic"),o.value(""),o.value("none",_("None")),o.value("srtp","SRTP"),o.value("utp","uTP"),o.value("wechat-video",_("Wechat Video")),o.value("dtls","DTLS 1.2"),o.value("wireguard","WireGuard"),(o=V.taboption("stream",form.Value,"ss_sockopt_mark","%s - %s".format(_("Sockopt"),_("Mark")),_("If transparent proxy is enabled, this option is ignored and will be set to 255."))).depends({protocol:/\b(wireguard|hysteria2)\b/,"!reverse":!0}),o.modalonly=!0,o.placeholder="255",(o=V.taboption("stream",widgets.NetworkSelect,"ss_sockopt_iface","%s- %s".format(_("Sockopt"),_("Interface")),_("Select outbound Interface"))).depends({protocol:"wireguard","!reverse":!0}),o.nocreate=!0,o.multiple=!1,o.rmempty=!0,o.filter=function(e,o){return o.toUpperCase().indexOf("LAN")<0},(o=V.taboption("stream",form.ListValue,"ss_sockopt_domain_strategy","%s - %s".format(_("Sockopt"),_("Domain strategy")))).modalonly=!0,o.depends({protocol:/\b(http|loopback|mtproto|shadowsocks|socks|trojan|vless|vmess)\b/}),o.value("AsIs"),o.value("UseIP"),o.value("UseIPv4"),o.value("UseIPv6"),(o=V.taboption("stream",form.ListValue,"ss_sockopt_tcp_fast_open","%s - %s".format(_("Sockopt"),_("TCP fast open")))).depends({protocol:/\b(wireguard|hysteria2)\b/,"!reverse":!0}),o.modalonly=!0,o.value(""),o.value("0",_("False")),o.value("1",_("True")),(o=V.taboption("stream",form.ListValue,"ss_sockopt_tcp_no_Delay","%s - %s".format(_("Sockopt"),_("TCP No Delay")))).depends("s_freedom_fragment_enabled","1"),o.modalonly=!0,o.rmempty=!0,o.value("0",_("False")),o.value("1",_("True")),(o=V.taboption("stream",form.ListValue,"ss_sockopt_dialer_proxy",_("Dialer Proxy"))).modalonly=!0,o.rmempty=!0,o.depends({protocol:/\b(wireguard|hysteria2)\b/,"!reverse":!0}),o.validate=function(e,o){return uci.get("v2ray",e,"tag")!=o||_("Unable to use current outbound as proxy")},o.value("",_("None"));for(P=0;P<d.length;P++)o.value(p[P].caption,d[P].caption+"("+p[P].caption+")");for(var K=0,j=y;K<j.length;K++)for(var z=j[K],$=0,G=String(z.caption).split(",");$<G.length;$++){var B=G[$];o.value(B.substring(0,B.indexOf("|")),B)}(o=V.taboption("stream",form.ListValue,"ss_sockopt_tcp_congestion","%s - %s".format("TCP",_("Congestion Control")))).modalonly=!0,o.rmempty=!0,o.value("",_("Default")),o.depends({protocol:/\b(http|trojan|vless|vmess)\b/,ss_network:/\b(grpc|h2|tcp|ws|httpupgrade)\b/}),o.depends({protocol:/\b(freedom|mtproto|socks)\b/});for(P=0;P<k.length;P++)o.value(k[P]);(o=V.taboption("general",form.ListValue,"proxy_settings_tag","%s - %s".format(_("Proxy settings"),_("Tag")))).modalonly=!0,o.rmempty=!0,o.depends({protocol:"hysteria2","!reverse":!0}),o.validate=function(e,o){return uci.get("v2ray",e,"tag")!=o||_("Unable to use current outbound as proxy")},o.value("",_("None"));for(P=0;P<d.length;P++)o.value(p[P].caption,d[P].caption+"("+p[P].caption+")");for(var Q=0,Y=y;Q<Y.length;Q++){z=Y[Q];for(var X=0,Z=String(z.caption).split(",");X<Z.length;X++){B=Z[X];o.value(B.substring(0,B.indexOf("|")),B)}}(o=V.taboption("stream",form.DummyValue,"reality_check")).depends({protocol:"wireguard","!reverse":!0}),o.hidden=!0,o.uciconfig="v2ray",o.ucisection="main",o.ucioption="reality",o.modalonly=!0,(o=V.taboption("mux",form.Flag,"mux_enabled","%s - %s".format(_("Mux"),_("Enabled")))).modalonly=!0,o.depends({ss_network:/\b(ws|tcp|grpc|h2|httpupgrade)\b/,ss_security:/\b(tls|none)\b/}),o.enabled="1",o.disabled="0",(o=V.taboption("mux",form.Value,"mux_concurrency",_("Mux Concurrency"))).modalonly=!0,o.depends("mux_enabled","1"),o.datatype="and(min(-1), max(1024), integer)",o.placeholder="8",(o=V.taboption("mux",form.Value,"xudp_concurrency",_("xudp Concurrency"))).modalonly=!0,o.depends({mux_enabled:"1",reality_check:"1"}),o.datatype="and(min(-1), max(1024), integer)",o.placeholder="8",(o=V.taboption("mux",form.ListValue,"xudp_proxy_udp443",_("Proxy UDP443"))).modalonly=!0,o.depends({mux_enabled:"1",reality_check:"1"}),o.value("reject",_("Reject")),o.value("allow",_("Allow")),o.value("skip",_("Skip"));var J=this;return w.render().then((function(e){var o=w.findElement("id","cbi-v2ray-outbound"),a=E("div",{class:"cbi-section-create cbi-tblsection-create"},E("button",{class:"cbi-button cbi-button-neutral",title:_("Import (Vmess Only)"),click:L.bind(J.handleImportClick,J)},_("Import (Vmess Only)")));return L.dom.append(o,a),e}))}});